<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Freeform Profile Editor</title>

<style>
:root{
    --bg-main:#0b0e14;
    --bg-panel:#121722;
    --bg-elev:#171d2b;
    --bg-input:#0f141d;
    --accent:#6ea8ff;
    --accent-glow:rgba(110,168,255,0.25);
    --danger:#ff647c;
    --success:#7CFC9F;
    --text-main:#e8ecf4;
    --text-dim:#8f9bb3;
    --border:#1f2635;
    --radius:16px;
    --radius-sm:12px;
    --shadow:0 25px 60px rgba(0,0,0,0.55);
}

/* =========================
   BASE
========================= */

*{
    box-sizing:border-box;
}

body{
    margin:0;
    padding:40px;
    background:
        radial-gradient(circle at 20% 0%, rgba(110,168,255,0.08), transparent 40%),
        linear-gradient(180deg,#0b0e14 0%, #0e131c 100%);
    color:var(--text-main);
    font-family:Inter, system-ui, -apple-system, sans-serif;
    letter-spacing:0.3px;
}

h1{
    margin:0 0 32px 0;
    font-size:30px;
    font-weight:700;
    background:linear-gradient(90deg,#ffffff,#9dbdff);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

label{
    display:block;
    margin-bottom:10px;
    font-size:12px;
    font-weight:600;
    color:var(--text-dim);
    text-transform:uppercase;
    letter-spacing:1.5px;
}

/* =========================
   LAYOUT WRAPPER
========================= */

.editor{
    position:relative;
    margin-bottom:28px;
    border-radius:var(--radius);
    background:var(--bg-panel);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    overflow:hidden;
    transition:all 0.25s ease;
}


/* =========================
   EDITOR LAYERS
========================= */

.editor textarea,
.editor .highlight{
    position:absolute;
    inset:0;
    transform: translateZ(0);
    color:#ffffff;

    padding:20px;

    font-family:Consolas, Monaco, monospace;
    font-size:13px;
    line-height:20px;

    letter-spacing:0;
    font-kerning:none;
    font-variant-ligatures:none;

    tab-size:4;

    white-space:pre;
    overflow:hidden;

    box-sizing:border-box;
}

/* highlight layer */
.editor .highlight{
    background:var(--bg-input);
    color:#ffffff;
    pointer-events:none;
    z-index:1;

    overflow:hidden;
    
    display:block;
}

/* textarea typing layer */
.editor textarea{
    background:transparent;
    color:#ffffff;
    caret-color:var(--accent);
    resize:none;
    outline:none;
    z-index:2;

    overflow:hidden;
    
    display:block;
}

/* focus glow */
.editor:focus-within{
    border-color:var(--accent);
    box-shadow:
        0 0 0 1px var(--accent),
        0 0 30px var(--accent-glow),
        var(--shadow);
}

/* =========================
   SCROLLBARS
========================= */

.editor textarea::-webkit-scrollbar,
.editor .highlight::-webkit-scrollbar{
    width:10px;
    height:10px;
}

.editor textarea::-webkit-scrollbar-thumb,
.editor .highlight::-webkit-scrollbar-thumb{
    background:#263047;
    border-radius:10px;
}

.editor textarea::-webkit-scrollbar-thumb:hover,
.editor .highlight::-webkit-scrollbar-thumb:hover{
    background:#324060;
}

/* =========================
   BUTTONS
========================= */

button{
    width:100%;
    padding:15px;
    border-radius:var(--radius);
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    border:none;
    transition:all 0.25s ease;
    margin-bottom:16px;
}

#saveBtn{
    background:linear-gradient(135deg,#5aa2ff,#7db5ff);
    color:white;
    box-shadow:0 10px 30px rgba(90,162,255,0.35);
}

#saveBtn:hover{
    transform:translateY(-3px);
    box-shadow:0 15px 40px rgba(90,162,255,0.45);
}

.secondary{
    background:var(--bg-elev);
    color:var(--text-main);
    border:1px solid var(--border);
}

.secondary:hover{
    background:#1e2638;
    transform:translateY(-2px);
}

/* =========================
   ERROR PANEL
========================= */

#errorPanel{
    padding:14px 16px;
    border-radius:var(--radius-sm);
    font-size:13px;
    margin-bottom:22px;
    background:var(--bg-elev);
    border:1px solid var(--border);
    transition:all 0.2s ease;
}

#errorPanel:empty{
    display:none;
}

/* =========================
   SYNTAX COLORS
========================= */

.token-tag{ color:#6ea8ff; }
.token-bracket{ color:#ff8bd6; }
.token-attr{ color:#ffd166; }
.token-string{ color:#7CFC9F; }
.token-template{ color:#ffb86c; }

/* =========================
   PREVIEW OVERLAY
========================= */

.preview-overlay{
    position:fixed;
    inset:0;
    background:rgba(5,8,14,0.85);
    backdrop-filter:blur(8px);
    display:none;
    justify-content:center;
    align-items:center;
    padding:40px;
    z-index:999;
}

.preview-box{
    width:100%;
    max-width:1100px;
    height:90%;
    background:var(--bg-panel);
    border-radius:var(--radius);
    border:1px solid var(--border);
    box-shadow:0 40px 80px rgba(0,0,0,0.7);
    position:relative;
    overflow:hidden;
    display:flex;
    flex-direction:column;
}

.close-btn{
    position:absolute;
    top:18px;
    alignment:center;
    right:18px;
    background:var(--danger);
    color:white;
    border:none;
    padding:8px 16px;
    border-radius:var(--radius-sm);
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.2s ease;

}

.close-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(255,100,124,0.35);
}

#previewRoot{
    flex:1;
    overflow:hidden;
    padding:32px;
}

/* =========================
   RESPONSIVE
========================= */

@media (max-width:900px){
    body{
        padding:24px;
    }

    .editor{
        height:240px;
    }

    .preview-box{
        height:95%;
    }
}

/*===============COLLAPSIBLE SECTION=================*/

.section{
    margin-bottom:30px;
}

.section-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:14px 18px;
    background:var(--bg-elev);
    border-radius:var(--radius-sm);
    font-size:13px;
    font-weight:600;
    letter-spacing:1px;
    cursor:pointer;
    user-select:none;
    border:1px solid var(--border);
}

.section-header:hover{
    background:#1e2638;
}

.section-body{
    margin-top:12px;
}

.section.collapsed .section-body{
    display:none;
}

.toggle{
    font-size:16px;
}


</style>
</head>

<body>

<h1>Freeform Profile Editor</h1>

<div class="section">
    <div class="section-header" data-target="htmlSection">
        HTML Layout
        <span class="toggle">−</span>
    </div>
    <div class="section-body" id="htmlSection">
        <div class="editor">
            <pre class="highlight" id="htmlHighlight"></pre>
            <textarea id="htmlInput" spellcheck="false"></textarea>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header" data-target="cssSection">
        CSS Styling
        <span class="toggle">−</span>
    </div>
    <div class="section-body" id="cssSection">
        <div class="editor">
            <pre class="highlight" id="cssHighlight"></pre>
            <textarea id="cssInput" spellcheck="false"></textarea>
        </div>
    </div>
</div>

<div id="errorPanel"></div>

<button id="saveBtn">Save Profile</button>
<button class="secondary" id="previewBtn">Preview</button>

<div class="preview-overlay" id="previewOverlay">
    <div class="preview-box">
        <button class="close-btn" id="closePreview">Close</button>
        <div id="previewRoot"></div>
    </div>
</div>

<script>

/* =========================
   LOAD CHARACTER
========================= */
let characters = JSON.parse(localStorage.getItem("characters")) || [];
let editingId = localStorage.getItem("editingCharacterId");
let char = characters.find(c => c.id === editingId);

if(!char){
    alert("No character selected.");
    window.location.href = "character.html";
}

if(!char.freeform){
    char.freeform = { html:"", css:"" };
}

const htmlInput = document.getElementById("htmlInput");
const cssInput = document.getElementById("cssInput");
const htmlHighlight = document.getElementById("htmlHighlight");
const cssHighlight = document.getElementById("cssHighlight");
const errorPanel = document.getElementById("errorPanel");

htmlInput.value = char.freeform.html || "";
cssInput.value = char.freeform.css || "";


/* =========================
   SAVE
========================= */
document.getElementById("saveBtn").addEventListener("click", ()=>{
    char.freeform.html = htmlInput.value;
    char.freeform.css = cssInput.value;
    char.updatedAt = new Date().toISOString();
    localStorage.setItem("characters", JSON.stringify(characters));
    alert("Freeform profile saved.");
});


/* =========================
   HARD SANITIZER
========================= */
function sanitizeHTML(input){

    if(!input) return "";

    // Remove script blocks
    input = input.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");

    // Remove dangerous container tags
    input = input.replace(/<(iframe|object|embed|svg|math|link|meta|base|form|input|button|textarea)[\s\S]*?>[\s\S]*?<\/\1>/gi, "");
    input = input.replace(/<(iframe|object|embed|svg|math|link|meta|base|form|input|button|textarea)[^>]*?>/gi, "");

    // Remove inline event handlers (onload, onclick, etc)
    input = input.replace(/\son\w+\s*=\s*(".*?"|'.*?'|[^\s>]+)/gi, "");

    // Remove javascript: and data:
    input = input.replace(/javascript:/gi, "");
    input = input.replace(/data:text\/html/gi, "");

    return input;
}


/* =========================
   CSS SANITIZER
========================= */
function sanitizeCSS(input){

    if(!input) return "";

    // Remove @import
    input = input.replace(/@import[^;]+;/gi, "");

    // Remove expression()
    input = input.replace(/expression\s*\([^)]*\)/gi, "");

    // Remove javascript URLs
    input = input.replace(/url\(\s*javascript:[^)]+\)/gi, "");

    // Remove behavior:
    input = input.replace(/behavior\s*:/gi, "");

    return input;
}


/* =========================
   TEMPLATE VARIABLES
========================= */
function applyTemplate(html){
    const replacements = {
        "{{name}}": char.name || "",
        "{{desc}}": char.desc || "",
        "{{tags}}": char.tags || "",
        "{{folder}}": char.folder || "",
        "{{image}}": char.image || ""
    };

    Object.keys(replacements).forEach(key=>{
        html = html.split(key).join(replacements[key]);
    });

    return html;
}


/* =========================
   SECURE PREVIEW (SANDBOXED IFRAME - FIX)
========================= */

const previewBtn = document.getElementById("previewBtn");
const previewOverlay = document.getElementById("previewOverlay");
const previewRoot = document.getElementById("previewRoot");
const closePreview = document.getElementById("closePreview");

previewBtn.addEventListener("click", ()=>{

    let safeHTML = sanitizeHTML(htmlInput.value);
    safeHTML = applyTemplate(safeHTML);
    const safeCSS = sanitizeCSS(cssInput.value);

    previewRoot.innerHTML = "";
    previewOverlay.style.display = "none";
    previewRoot.innerHTML = "";

    const iframe = document.createElement("iframe");

    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    

    // Scripts disabled
    iframe.setAttribute("sandbox", "");

    iframe.srcdoc = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta http-equiv="Content-Security-Policy"
                  content="default-src 'none'; style-src 'unsafe-inline'; img-src https: data:;">
            <style>
                body {
                    background:#161a23;
                    color:#ffffff;
                    font-family:Inter, system-ui, sans-serif;
                    padding:24px;
                }
                ${safeCSS}
            </style>
        </head>
        <body>
            ${safeHTML}
        </body>
        </html>
    `;

    previewRoot.appendChild(iframe);

    previewOverlay.style.display = "flex";
});
/* =========================
   ESCAPE
========================= */
function escapeHTML(str){
    return str.replace(/&/g,"&amp;")
              .replace(/</g,"&lt;")
              .replace(/>/g,"&gt;");
}


/* =========================
   SYNTAX HIGHLIGHTING
========================= */

function highlightHTML(code){
    code = escapeHTML(code);

    code = code.replace(/(\{\{.*?\}\})/g,
        '<span class="token-template">$1</span>');

    code = code.replace(/(&lt;|&gt;)/g,
        '<span class="token-bracket">$1</span>');

    code = code.replace(/(&lt;\/?[a-zA-Z0-9-]+)/g,
        '<span class="token-tag">$1</span>');

    code = code.replace(/([a-zA-Z-:]+)=/g,
        '<span class="token-attr">$1</span>=');

    code = code.replace(/(".*?"|\'.*?\')/g,
        '<span class="token-string">$1</span>');

    return code;
}

function highlightCSS(code){
    code = escapeHTML(code);

    code = code.replace(/(^|\n)([^\{\}\n]+)(?=\s*\{)/g,
        '$1<span class="token-tag">$2</span>');

    code = code.replace(/([a-zA-Z-]+)(?=\s*:)/g,
        '<span class="token-attr">$1</span>');

    code = code.replace(/:\s*([^;]+)/g,
        ': <span class="token-string">$1</span>');

    return code;
}


/* =========================
   ERROR DETECTION
========================= */

function detectErrors(html, css){

    let errors = [];

    const voidTags = ["br","hr","img","input","meta","link","area","base","col","embed","param","source","track","wbr"];

    const tagStack = [];
    const tagRegex = /<\/?([a-zA-Z0-9-]+)[^>]*>/g;
    let match;

    while((match = tagRegex.exec(html)) !== null){
        const fullTag = match[0];
        const tagName = match[1].toLowerCase();

        if(voidTags.includes(tagName)) continue;

        if(fullTag.startsWith("</")){
            if(tagStack[tagStack.length - 1] === tagName){
                tagStack.pop();
            } else {
                errors.push(`Unexpected closing tag: </${tagName}>`);
            }
        } else if(!fullTag.endsWith("/>")){
            tagStack.push(tagName);
        }
    }

    if(tagStack.length > 0){
        errors.push(`Unclosed tag: <${tagStack[tagStack.length - 1]}>`);
    }

    let openBraces = (css.match(/{/g) || []).length;
    let closeBraces = (css.match(/}/g) || []).length;

    if(openBraces !== closeBraces){
        errors.push("Unmatched { } in CSS.");
    }

    if(/<script/i.test(html)){
        errors.push("Script tags are not allowed.");
    }

    if(/javascript:/i.test(html)){
        errors.push("javascript: URLs are not allowed.");
    }

    return errors;
}


/* =========================
   LIVE UPDATE
========================= */
function updateEditors(){

    const htmlCode = htmlInput.value;
    const cssCode = cssInput.value;

    // Preserve final newline to prevent vertical drift
    const htmlSafe = htmlCode.endsWith("\n") ? htmlCode + " " : htmlCode;
    const cssSafe = cssCode.endsWith("\n") ? cssCode + " " : cssCode;

    htmlHighlight.innerHTML = highlightHTML(htmlSafe);
    cssHighlight.innerHTML = highlightCSS(cssSafe);

    const errors = detectErrors(htmlCode, cssCode);

    if(errors.length > 0){
        errorPanel.style.color = "#ff5a7a";
        errorPanel.innerHTML = errors.join("<br>");
    } else {
        errorPanel.style.color = "#7CFC9F";
        errorPanel.innerHTML = "✓ No syntax errors detected.";
    }
}

/* =========================
   AUTO EXPAND
========================= */

function autoResize(textarea, highlight){
    const editor = textarea.parentElement;

    textarea.style.height = "auto";
    highlight.style.height = "auto";
    editor.style.height = "auto";

    const newHeight = textarea.scrollHeight + "px";

    textarea.style.height = newHeight;
    highlight.style.height = newHeight;
    editor.style.height = newHeight;
}

bindAutoResize(htmlInput, htmlHighlight);
bindAutoResize(cssInput, cssHighlight);

/* =========================
   COLLAPSE SECTIONS
========================= */

document.querySelectorAll(".section-header").forEach(header=>{
    header.addEventListener("click", ()=>{
        const section = header.parentElement;
        const toggle = header.querySelector(".toggle");

        section.classList.toggle("collapsed");

        toggle.textContent =
            section.classList.contains("collapsed") ? "+" : "−";
    });
});

// Close button
closePreview.addEventListener("click", closeOverlay);

// Click outside preview box
previewOverlay.addEventListener("click", (e) => {
    if (e.target === previewOverlay) {
        closeOverlay();
    }
});

// ESC key
document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && previewOverlay.style.display === "flex") {
        closeOverlay();
    }
});

function closeOverlay() {
    previewOverlay.style.display = "none";
    previewRoot.innerHTML = "";
}


</script>


</body>
</html>
